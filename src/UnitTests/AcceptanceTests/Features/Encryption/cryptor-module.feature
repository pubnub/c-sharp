@featureSet=cryptoModule @beta
Feature: Crypto module
  As a PubNub user
  I want to be able to encrypt data using crypto module
  I want to be able to decrypt data generated by previous cryptors

  Scenario Outline: AES-CBC cryptor data header can be processed
    Given Crypto module with 'acrh' cryptor
    * with '<cipher_key>' cipher key
    When I decrypt '<file>' file
    Then I receive '<outcome>'

    Examples:
      |  cipher_key  |              file              |        outcome        |
      # A file containing encrypted data without a header is ineligible for
      # processing by the crypto module, which  doesn't have a legacy cryptor
      # registered.
      | pubnubenigma | file-legacy-civ.jpg            | unknown cryptor error |
      # A file containing encrypted data with a header that doesn't contain a
      # version is ineligible for processing by a specific cryptor registered
      # in the crypto module.
      | pubnubenigma | file-cryptor-no-version.txt    | decryption error      |
      # A file containing encrypted data with a header containing an unknown
      # version is ineligible for processing.
      | pubnubenigma | file-cryptor-unknown-acrh.jpg  | unknown cryptor error |
      # A file containing encrypted data with a header containing a too short
      # cryptor identifier is ineligible for processing.
      | pubnubenigma | file-cryptor-v1-short.txt      | decryption error      |
      # A file containing encrypted data with a header containing a cryptor
      # identifier that isn't registered in the crypto module is ineligible
      # for processing.
      | pubnubenigma | file-cryptor-v1-unknown.txt    | unknown cryptor error |
      # A file without content is ineligible for processing.
      | pubnubenigma | empty-file-cryptor-v1-acrh.txt | decryption error      |
      | pubnubenigma | file-cryptor-v1-acrh.jpg       | success               |

  Scenario Outline: Empty data encryption should fail
    Given Crypto module with '<cryptor_id>' cryptor
    * with '<cipher_key>' cipher key
    * with '<vector>' vector
    When I encrypt 'empty-file.txt' file as 'binary'
    Then I receive 'encryption error'

    Examples:
      | cryptor_id |  cipher_key  |  vector  |
      | legacy     | pubnubenigma | constant |
      | legacy     | pubnubenigma | random   |
      | acrh       | pubnubenigma | -        |
      | acrh       | pubnubenigma | -        |

  # Stream-based encryption may not be supported by all platforms so it has been moved to the
  # separate scenario with ability to opt-out.
  @na=rust @na=dart @na=ruby
  Scenario Outline: Empty stream data encryption should fail
    Given Crypto module with '<cryptor_id>' cryptor
    * with '<cipher_key>' cipher key
    * with '<vector>' vector
    When I encrypt 'empty-file.txt' file as 'stream'
    Then I receive 'encryption error'

    Examples:
      | cryptor_id |  cipher_key  |  vector  |
      | legacy     | pubnubenigma | constant |
      | legacy     | pubnubenigma | random   |
      | acrh       | pubnubenigma | -        |
      | acrh       | pubnubenigma | -        |

  Scenario Outline: Empty data decryption should fail
    Given Crypto module with '<cryptor_id>' cryptor
    * with '<cipher_key>' cipher key
    * with '<vector>' vector
    When I decrypt '<encrypted_file>' file as 'binary'
    Then I receive 'decryption error'

    Examples:
      | cryptor_id |  cipher_key  |  vector  |          encrypted_file           |
      | legacy     | pubnubenigma | constant | empty-file.txt                    |
      | legacy     | pubnubenigma | random   | empty-file.txt                    |
      | acrh       | pubnubenigma | -        | empty-file.txt                    |
      # A file containing only initialization vector is ineligible for processing.
      | legacy     | pubnubenigma | random   | empty-file-cryptor-legacy-riv.txt |
      # A file containing only header and initialization vector is ineligible for
      # processing.
      | acrh       | pubnubenigma | -        | empty-file-cryptor-v1-acrh.txt    |

  # Stream-based decryption may not be supported by all platforms so it has been moved to the
  # separate scenario with ability to opt-out.
  @na=rust @na=dart @na=ruby
  Scenario Outline: Empty stream data decryption should fail
    Given Crypto module with '<cryptor_id>' cryptor
    * with '<cipher_key>' cipher key
    * with '<vector>' vector
    When I decrypt '<encrypted_file>' file as 'stream'
    Then I receive 'decryption error'

    Examples:
      | cryptor_id |  cipher_key  |  vector  |          encrypted_file           |
      | legacy     | pubnubenigma | constant | empty-file.txt                    |
      | legacy     | pubnubenigma | random   | empty-file.txt                    |
      | acrh       | pubnubenigma | -        | empty-file.txt                    |
      # A file containing only initialization vector is ineligible for processing.
      | legacy     | pubnubenigma | random   | empty-file-cryptor-legacy-riv.txt |
      # A file containing only header and initialization vector is ineligible for
      # processing.
      | acrh       | pubnubenigma | -        | empty-file-cryptor-v1-acrh.txt    |

  Scenario Outline: Data encrypted with legacy AES-CBC cryptor is decryptable with legacy implementation
    Given Crypto module with 'legacy' cryptor
    * with '<cipher_key>' cipher key
    * with '<vector>' vector
    Given Legacy code with '<cipher_key>' cipher key and '<vector>' vector
    When I encrypt '<file>' file as 'binary'
    Then Successfully decrypt an encrypted file with legacy code

    Examples:
      |  cipher_key  |  vector  |      file      |
      | pubnubenigma | random   | file.jpg       |
      | pubnubenigma | constant | file.jpg       |
      | pubnubenigma | random   | file.txt       |
      | pubnubenigma | constant | file.txt       |

  # Stream-based encryption may not be supported by all platforms so it has been moved to the
  # separate scenario with ability to opt-out.
  @na=rust @na=dart @na=ruby
  Scenario Outline: Stream data encrypted with legacy AES-CBC cryptor is decryptable with legacy implementation
    Given Crypto module with 'legacy' cryptor
    Given Legacy code with '<cipher_key>' cipher key and '<vector>' vector
    * with '<cipher_key>' cipher key
    * with '<vector>' vector
    When I encrypt '<file>' file as 'stream'
    Then Successfully decrypt an encrypted file with legacy code

    Examples:
      |  cipher_key  | vector |      file      |
      | pubnubenigma | random | file.jpg       |
      | pubnubenigma | random | file.txt       |

  Scenario Outline: Cryptor is able to process sample files as binary
    Given Crypto module with '<cryptor_id>' cryptor
    * with '<cipher_key>' cipher key
    * with '<vector>' vector
    When I decrypt '<encrypted_file>' file as 'binary'
    Then Decrypted file content equal to the '<source_file>' file content

    Examples:
      | cryptor_id |  cipher_key  |  vector  |          encrypted_file           |  source_file   |
      | legacy     | pubnubenigma | constant | file-cryptor-legacy-civ.jpg       | file.jpg       |
      | legacy     | pubnubenigma | random   | file-cryptor-legacy-riv.jpg       | file.jpg       |
      | legacy     | pubnubenigma | constant | file-cryptor-legacy-civ.txt       | file.txt       |
      | legacy     | pubnubenigma | random   | file-cryptor-legacy-riv.txt       | file.txt       |
      | legacy     | pubnubenigma | constant | file-legacy-civ.jpg               | file.jpg       |
      | legacy     | pubnubenigma | random   | file-legacy-riv.jpg               | file.jpg       |
      | legacy     | pubnubenigma | constant | file-legacy-civ.txt               | file.txt       |
      | legacy     | pubnubenigma | random   | file-legacy-riv.txt               | file.txt       |
      | acrh       | pubnubenigma | -        | file-cryptor-v1-acrh.jpg          | file.jpg       |
      | acrh       | pubnubenigma | -        | file-cryptor-v1-acrh.txt          | file.txt       |

  # Stream-based decryption may not be supported by all platforms so it has been moved to the
  # separate scenario with ability to opt-out.
  @na=rust @na=dart @na=ruby
  Scenario Outline: Cryptor is able to process sample files as stream
    Given Crypto module with '<cryptor_id>' cryptor
    * with '<cipher_key>' cipher key
    * with '<vector>' vector
    When I decrypt '<encrypted_file>' file as 'stream'
    Then Decrypted file content equal to the '<source_file>' file content

    Examples:
      | cryptor_id |  cipher_key  |  vector  |          encrypted_file           |  source_file   |
      | legacy     | pubnubenigma | random   | file-cryptor-legacy-riv.jpg       | file.jpg       |
      | legacy     | pubnubenigma | random   | file-cryptor-legacy-riv.txt       | file.txt       |
      | legacy     | pubnubenigma | random   | file-legacy-riv.jpg               | file.jpg       |
      | legacy     | pubnubenigma | random   | file-legacy-riv.txt               | file.txt       |
      | acrh       | pubnubenigma | -        | file-cryptor-v1-acrh.jpg          | file.jpg       |
      | acrh       | pubnubenigma | -        | file-cryptor-v1-acrh.txt          | file.txt       |

  Scenario Outline: Crypto module can handle encrypted data from different cryptors
    Given Crypto module with default '<cryptor_id1>' and additional '<cryptor_id2>' cryptors
    * with '<cipher_key>' cipher key
    * with '<vector>' vector
    When I decrypt '<encrypted_file>' file as 'binary'
    Then Decrypted file content equal to the '<source_file>' file content

    Examples:
      | cryptor_id1 | cryptor_id2 |  cipher_key  |  vector  |          encrypted_file           |  source_file   |
      | legacy      | acrh        | pubnubenigma | constant | file-cryptor-legacy-civ.jpg       | file.jpg       |
      | acrh        | legacy      | pubnubenigma | random   | file-legacy-riv.jpg               | file.jpg       |
